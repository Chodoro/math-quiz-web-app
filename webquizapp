<?php
// Start the session
session_start();

// Initialize game settings and state
if (!isset($_SESSION['settings'])) {
    $_SESSION['settings'] = [
        'level' => 1, // Default level
        'custom_min' => 1, // Custom range min
        'custom_max' => 10, // Custom range max
    ];
}

if (!isset($_SESSION['game_state'])) {
    resetGame();
}

// Reset game state
function resetGame() {
    $_SESSION['game_state'] = [
        'current_question' => 1,
        'correct' => 0,
        'wrong' => 0,
        'questions' => [], // Store past questions
        'current_question_data' => null,
    ];
}

// Generate a random math question
function generateQuestion() {
    $level = $_SESSION['settings']['level'];
    $min = ($level == 1) ? 1 : 11;
    $max = ($level == 1) ? 10 : 100;

    if ($level == 'custom') {
        $min = $_SESSION['settings']['custom_min'];
        $max = $_SESSION['settings']['custom_max'];
    }

    // Generate two random numbers
    $num1 = rand($min, $max);
    $num2 = rand($min, $max);

    // Choose a random operator
    $operators = ['+', '-', '*'];
    $operator = $operators[array_rand($operators)];

    // Calculate the correct answer
    switch ($operator) {
        case '+':
            $correctAnswer = $num1 + $num2;
            break;
        case '-':
            $correctAnswer = $num1 - $num2;
            break;
        case '*':
            $correctAnswer = $num1 * $num2;
            break;
    }

    // Generate options including the correct answer
    $options = [$correctAnswer];
    while (count($options) < 4) {
        $fakeAnswer = rand($correctAnswer - 10, $correctAnswer + 10);
        if ($fakeAnswer != $correctAnswer && !in_array($fakeAnswer, $options)) {
            $options[] = $fakeAnswer;
        }
    }
    shuffle($options);

    // Store the question data
    $_SESSION['game_state']['current_question_data'] = [
        'num1' => $num1,
        'num2' => $num2,
        'operator' => $operator,
        'correct_answer' => $correctAnswer,
        'options' => $options,
    ];
}

// Handle game logic
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Handle level settings
    if (isset($_POST['level'])) {
        $_SESSION['settings']['level'] = $_POST['level'];
        if ($_POST['level'] == 'custom') {
            $_SESSION['settings']['custom_min'] = intval($_POST['custom_min']);
            $_SESSION['settings']['custom_max'] = intval($_POST['custom_max']);
        }
        resetGame();
        generateQuestion();
    }

    // Handle answer submission
    if (isset($_POST['answer'])) {
        $selectedAnswer = intval($_POST['answer']);
        $correctAnswer = $_SESSION['game_state']['current_question_data']['correct_answer'];

        if ($selectedAnswer === $correctAnswer) {
            $_SESSION['game_state']['correct']++;
        } else {
            $_SESSION['game_state']['wrong']++;
        }

        // Move to the next question
        $_SESSION['game_state']['current_question']++;
        if ($_SESSION['game_state']['current_question'] <= 10) {
            generateQuestion();
        } else {
            $_SESSION['game_state']['quiz_over'] = true;
        }
    }

    // Handle game reset
    if (isset($_POST['reset'])) {
        resetGame();
        generateQuestion();
    }
}

// Generate the first question if not already generated
if (!isset($_SESSION['game_state']['current_question_data'])) {
    generateQuestion();
}

// Get current question data
$questionData = $_SESSION['game_state']['current_question_data'];
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Quiz Game</title>
</head>
<body>
</body>
</html>
